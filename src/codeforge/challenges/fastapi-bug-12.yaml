id: fastapi-bug-12
title: "HTTPBearer optional 模式下错误的 scheme 仍然抛异常而非返回 None"
repo: tiangolo/fastapi
difficulty: easy
time_limit: 20
description: |
  FastAPI 的 `HTTPBearer` 安全组件用于从请求的 `Authorization` header 中提取
  Bearer token。它有一个 `auto_error` 参数：
  - `auto_error=True`（默认）：认证失败时自动抛出 403 异常
  - `auto_error=False`（可选模式）：认证失败时返回 `None`，让开发者自行处理

  当 `auto_error=False` 时，这意味着开发者希望认证是可选的——没有 token 或
  token 格式不对时不应该直接报错。

  **问题现象：**
  设置 `auto_error=False` 后，当请求缺少 Authorization header 时能正确返回 None。
  但当请求提供了 Authorization header 但 scheme 不是 "bearer"（例如 "Basic xxx"）
  时，代码仍然无条件抛出 403 异常，没有检查 `auto_error` 标志。

  这导致"可选认证"的行为不一致：缺少 header 时正常，scheme 错误时却崩溃。

  **期望行为：**
  当 `auto_error=False` 时，**所有**认证失败的情况（包括缺少 header 和 scheme
  不匹配）都应该返回 `None`，而不是抛出异常。
setup:
  base_commit: "d61f5e4b555b123bf222503fc0e076cbae6a7ebc"
  solution_commit: "d262f6e9296993e528e2327f0a73f7bf5514e7c6"
  test_command: "pytest tests/test_security_http_bearer_optional.py::test_security_http_bearer_incorrect_scheme_credentials"
  files_of_interest:
    - fastapi/security/http.py
tags: [auth, auto-error, consistency, conditional-logic]
hints:
  - "查看 fastapi/security/http.py 中 HTTPBearer 类的 __call__ 方法"
  - "注意当 scheme != 'bearer' 时的处理逻辑——它直接 raise HTTPException，但没有先检查 self.auto_error"
  - "应该和处理缺少 credentials 的逻辑保持一致：auto_error=True 时抛异常，auto_error=False 时返回 None"
