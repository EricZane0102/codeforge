id: scrapy-bug-28
title: "RFPDupeFilter 以 append 模式打开文件后未 seek 导致无法读取已有内容"
repo: scrapy/scrapy
difficulty: easy
time_limit: 20
description: |
  Scrapy 的 `RFPDupeFilter`（Request Fingerprint Duplicate Filter）用于过滤
  重复的请求。当配置了持久化路径时，它会将已见过的 request fingerprint 写入
  文件 `requests.seen`，以便在爬虫重启后恢复去重状态。

  初始化时，代码以 `'a+'` 模式打开文件（可追加写入 + 可读取），然后尝试读取
  文件中已有的 fingerprint 来恢复状态。

  **问题现象：**
  爬虫重启后，`RFPDupeFilter` 无法正确恢复之前的去重状态。即使 `requests.seen`
  文件中已经有之前保存的 fingerprint 数据，重启后这些数据不会被加载，
  导致之前已经爬过的 URL 被重新请求。

  **期望行为：**
  以 `'a+'` 模式打开文件后，应该能正确读取文件中已有的所有内容，将其加载到
  内存中的 fingerprint 集合里，从而正确恢复去重状态。
setup:
  base_commit: "e2f31f3018c0037f65982209c22f93b80a5d6e7b"
  solution_commit: "457b97c13ccf9a84f3dc7800c180cf059822c09a"
  test_command: "python -m unittest -q tests.test_dupefilters.RFPDupeFilterTest.test_dupefilter_path"
  files_of_interest:
    - scrapy/dupefilters.py
tags: [file-io, seek, file-mode]
hints:
  - "查看 scrapy/dupefilters.py 中 RFPDupeFilter.__init__ 方法里打开文件的部分"
  - "Python 中以 'a+' 模式打开文件时，文件指针的初始位置在哪里？"
  - "'a+' 模式下文件指针默认在末尾——要读取内容需要先将指针移到文件开头"
